<!DOCTYPE html>
<html>
  <head>
    <title>{% if page.title %}{{ page.title }} – {% endif %}{{ site.name }} – {{ site.description }}</title>

    {% include meta.html %}

    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" type="text/css" href="{{ site.baseurl }}/style.css" />
    <link rel="alternate" type="application/rss+xml" title="{{ site.name }} - {{ site.description }}" href="{{ site.baseurl }}/feed.xml" />

    <!-- GLightbox CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css" />

    <!-- Created with Jekyll Now - http://github.com/barryclark/jekyll-now -->
  </head>

  <body>
    <div class="wrapper-masthead">
      <div class="container">
        <header class="masthead clearfix">
          <a href="{{ site.baseurl }}/" class="site-avatar"><img src="{{ site.avatar }}" /></a>

          <div class="site-info">
            <h1 class="site-name"><a href="{{ site.baseurl }}/">{{ site.name }}</a></h1>
            <p class="site-description">{{ site.description }}</p>
          </div>

          <nav>
            <a href="{{ site.baseurl }}/misadventures">Misadventures</a>
            <a href="{{ site.baseurl }}/animation">Animation</a>
            <a href="{{ site.baseurl }}/about">About</a>
          </nav>
        </header>
      </div>
    </div>

    <div id="main" role="main" class="container">
      {{ content }}
    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          {% include svg-icons.html %}
        </footer>
      </div>
    </div>

    {% include analytics.html %}
    
    <!-- Borrowed from https://www.npmjs.com/package/vanilla-back-to-top -->
    <!-- Used under https://github.com/vfeskov/vanilla-back-to-top/blob/v7.1.14/LICENSE -->
    <script src="https://unpkg.com/vanilla-back-to-top@7.1.14/dist/vanilla-back-to-top.min.js"></script>
    <script>addBackToTop({
      diameter: 56,
      backgroundColor: '#e8985c',
      textColor: '#ffffff'
    })</script>

    <!-- GLightbox JS -->
    <script src="https://cdn.jsdelivr.net/npm/glightbox/dist/js/glightbox.min.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Check if we're on a post listing page (has .posts container with multiple posts)
        const postsContainer = document.querySelector('.posts');
        const isListingPage = postsContainer && postsContainer.querySelectorAll('.post').length > 0;
        
        // Find all images in the main content area that are not already wrapped in lightbox links
        const mainContent = document.getElementById('main');
        if (mainContent) {
          const images = mainContent.querySelectorAll('img:not(.no-lightbox)');
          
          images.forEach(function(img, index) {
            // Skip images that are already wrapped in an anchor tag with glightbox class
            if (img.parentElement.tagName === 'A' && img.parentElement.classList.contains('glightbox')) {
              return;
            }
            
            // Check if this image is inside a post entry on a listing page
            const isInPostEntry = img.closest('.entry') !== null;
            
            // On listing pages, make images in post entries link to the post
            if (isListingPage && isInPostEntry) {
              const postArticle = img.closest('.post');
              if (postArticle) {
                const postLink = postArticle.querySelector('h1 a');
                if (postLink) {
                  const parent = img.parentElement;
                  
                  // If image isn't already wrapped in a link, wrap it
                  if (parent.tagName !== 'A') {
                    const wrapper = document.createElement('a');
                    wrapper.href = postLink.href;
                    wrapper.classList.add('post-image-link');
                    img.parentNode.insertBefore(wrapper, img);
                    wrapper.appendChild(img);
                  }
                  // Skip lightbox processing for this image
                  return;
                }
              }
            }
            
            // Skip images that are already wrapped in any anchor tag (like linked images)
            // unless we want to override - for now, let's wrap them for lightbox
            const parent = img.parentElement;
            
            // Create a wrapper anchor for the lightbox
            const wrapper = document.createElement('a');
            wrapper.href = img.src;
            wrapper.classList.add('glightbox');
            wrapper.setAttribute('data-gallery', 'page-gallery');
            
            // Use alt text as the caption if available
            if (img.alt) {
              wrapper.setAttribute('data-glightbox', 'title: ' + img.alt);
            }
            
            // If the image is already wrapped in an anchor, replace the anchor's functionality
            if (parent.tagName === 'A') {
              // Keep the original link but add lightbox functionality
              parent.classList.add('glightbox');
              parent.setAttribute('data-gallery', 'page-gallery');
              if (img.alt) {
                parent.setAttribute('data-glightbox', 'title: ' + img.alt);
              }
              // Update href to point to the image for lightbox
              parent.setAttribute('data-href', img.src);
              parent.href = img.src;
            } else {
              // Wrap the image in the new anchor
              img.parentNode.insertBefore(wrapper, img);
              wrapper.appendChild(img);
            }
          });
        }
        
        // Initialize GLightbox with gallery thumbnails and navigation
        const lightbox = GLightbox({
          selector: '.glightbox',
          touchNavigation: true,
          loop: true,
          autoplayVideos: true,
          openEffect: 'zoom',
          closeEffect: 'zoom',
          cssEfects: {
            fade: { in: 'fadeIn', out: 'fadeOut' },
            zoom: { in: 'zoomIn', out: 'zoomOut' }
          }
        });
      });
    </script>

    <!-- Mermaid.js for inline diagrams -->
    <script type="module">
      import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
      mermaid.initialize({
        startOnLoad: false,
        theme: 'neutral',
        themeVariables: {
          background: 'transparent'
        }
      });
      // Convert ```mermaid code blocks (rendered by Kramdown as <code class="language-mermaid">) into Mermaid containers
      document.querySelectorAll('code.language-mermaid').forEach(el => {
        const pre = el.parentElement;
        const div = document.createElement('div');
        div.classList.add('mermaid');
        div.textContent = el.textContent;
        pre.parentNode.replaceChild(div, pre);
      });
      await mermaid.run();
    </script>
  </body>
</html>
